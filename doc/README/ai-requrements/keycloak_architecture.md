---
title: Архитектура аутентификации с использованием Keycloak
---

## 1\. Обзор решения

### 1\.1. Цель

Интеграция Keycloak как центрального сервиса управления идентификацией и доступом (IAM) для обеспечения единой точки аутентификации, авторизации и управления пользователями.

### 1\.2. Ключевые преимущества

-  **Единый источник истины** для пользовательских данных и ролей

-  **Поддержка стандартов** OAuth 2.0, OpenID Connect, SAML 2.0

-  **Готовые функции**: многофакторная аутентификация, социальные логины, self-service

-  **Централизованное управление** клиентами, ролями, политиками

-  **Масштабируемость** через кластеризацию и репликацию

### 1\.3. Область применения

-  Аутентификация пользователей через веб и мобильные приложения

-  Авторизация API на основе ролей (RBAC)

-  Федерация идентификации с внешними провайдерами (Google, GitHub, LDAP)

-  Управление сессиями и single sign-on (SSO)

-  Аудит событий безопасности

## 2\. Архитектурные решения

### 2\.1. Выбор Keycloak vs кастомное решение

| Критерий                     | Keycloak                    | Кастомное решение              |
|------------------------------|-----------------------------|--------------------------------|
| Время разработки             | Несколько дней              | Несколько месяцев              |
| Поддержка стандартов         | Полная (OIDC, OAuth2, SAML) | Требует реализации             |
| Безопасность                 | Протестировано сообществом  | Риск уязвимостей               |
| Масштабируемость             | Готовая кластеризация       | Требует разработки             |
| Тотальная стоимость владения | Низкая (open source)        | Высокая (разработка+поддержка) |

**Решение:** Использовать Keycloak как готовое решение, сфокусировавшись на интеграции, а не реализации базовых функций IAM.

### 2\.2. Модель развертывания

-  **Контейнеризация**: Keycloak в Docker с официальным образом `quay.io/keycloak/keycloak`

-  **Оркестрация**: Kubernetes StatefulSet для stateful компонентов

-  **База данных**: PostgreSQL с репликацией (внешняя от Keycloak)

-  **Кэширование**: Infinispan embedded для распределенного кэша сессий

-  **Балансировка нагрузки**: Ingress с TLS termination

### 2\.3. Модель данных Keycloak

Keycloak использует собственную схему данных с сущностями:

-  **Realms**: Изолированные пространства для клиентов (например, "production", "staging")

-  **Clients**: Приложения, которые используют аутентификацию (SPA, мобильное приложение, backend API)

-  **Users**: Пользователи с атрибутами, учетными данными и ролями

-  **Roles**: Глобальные и client-specific роли

-  **Groups**: Иерархические группы пользователей

-  **Identity Providers**: Внешние провайдеры (Google, LDAP, SAML)

## 3\. Диаграмма контейнеров (C4 Level 2)

Создам PlantUML диаграмму контейнеров.

[plant-uml:./c4_Level_2_containers_diagram_KeycloakAuth_v1.plantuml::110px:120px]

\<write_to_file> \<path>c4_Level_2_containers_diagram_KeycloakAuth_v1.plantuml\</path>

\<content>

[plant-uml:./keycloak_architecture-2.puml::1207px:1000px]